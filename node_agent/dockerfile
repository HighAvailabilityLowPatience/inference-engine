FROM python:3.12-slim

WORKDIR /app

# Copy requirement files first
COPY corerequirements.txt extendedrequirements.txt ./

# Install core Python dependencies
RUN pip install --no-cache-dir -r corerequirements.txt

# Create a proper module directory inside the container
RUN mkdir -p /app/node_agent

# Copy source code INTO the node_agent module folder
COPY . /app/node_agent

# Ensure `/app` is recognized as a package root
ENV PYTHONPATH=/app

# Default mode
ENV MODE=core

# Launch the agent properly
CMD if [ "$MODE" = "extended" ]; then \
        pip install --no-cache-dir -r /app/node_agent/extendedrequirements.txt && \
        python -m node_agent.agent; \
    else \
        python -m node_agent.agent; \
    fi
